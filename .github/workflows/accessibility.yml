name: Accessibility Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: ESLint Accessibility Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./webapp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './webapp/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (Accessibility Rules)
        run: npm run lint
        continue-on-error: false

  build:
    name: Build Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./webapp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './webapp/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: ./webapp/.next
          retention-days: 1

  pa11y:
    name: Pa11y Automated Tests
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ./webapp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './webapp/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: ./webapp/.next

      - name: Start Next.js server
        run: |
          npm run start &
          sleep 10
          curl --retry 10 --retry-delay 3 --retry-connrefused http://localhost:3000

      - name: Run Pa11y Tests
        run: npm run test:a11y
        env:
          TEST_URL: http://localhost:3000

      - name: Upload Pa11y Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-report
          path: ./webapp/pa11y-results.json
          retention-days: 7

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, build, pa11y]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ESLint ì ‘ê·¼ì„± ê²€ì‚¬**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ë¹Œë“œ í…ŒìŠ¤íŠ¸**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Pa11y ìžë™í™” í…ŒìŠ¤íŠ¸**: ${{ needs.pa11y.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **WCAG 2.2 Level AA ì¤€ìˆ˜ ëª©í‘œ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ] && [ "${{ needs.pa11y.result }}" == "success" ]; then
            echo "ðŸŽ‰ ëª¨ë“  ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi
